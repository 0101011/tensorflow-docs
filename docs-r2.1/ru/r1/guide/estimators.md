# Estimators

Note: Вся информация в этом разделе переведена с помощью русскоговорящего
Tensorflow сообщества на общественных началах. Поскольку этот перевод не
является официальным, мы не гарантируем что он на 100% аккуратен и соответствует
[официальной документации на английском языке](https://www.tensorflow.org/?hl=en).
Если у вас есть предложение как исправить этот перевод, мы будем очень рады
увидеть pull request в [tensorflow/docs](https://github.com/tensorflow/docs)
репозиторий GitHub. Если вы хотите помочь сделать документацию по Tensorflow
лучше (сделать сам перевод или проверить перевод подготовленный кем-то другим),
напишите нам на
[docs-ru@tensorflow.org list](https://groups.google.com/a/tensorflow.org/forum/#!forum/docs-ru).

В этом документе мы познакомимся `tf.estimator`, высокоуровневым API TensorFlow,
который значительно упрощает процесс создания моделей машинного обучения.
Estimators включает в себя следующие операции:

*   обучение
*   оценку
*   предсказание
*   экспорт модели на сервер

Ты можешь использовать либо уже готовые Estimators или написать свои
собственные для оценки. Все Estimators основаны на классе `tf.estimator.Estimator`.

Для быстрого ознакомления попробуй запустить [интерактивные уроки по Estimator](../tutorials/estimators/linear.ipynb)
в Google Colab. Чтобы узнать о каждой функции подробнее смотри статью [готовые Estimators](premade_estimators.md).
Для ознакомления с дизайном этого API смотри наш [доклад на arxiv.org](https://arxiv.org/abs/1708.02637).

Обрати внимание: TensorFlow также включает в себя устаревший класс
`Estimator` в `tf.contrib.learn.Estimator`, который использовать не стоит.


## Преимущества Estimators

Estimators обеспечивают следующие преимущества:

*   Можно запускать модели на основе Estimators локально или на распределенном
    сервере без изменений структуры модели. Более того, ты можешь запускать модели
    на CPU, GPU и TPU без внесения изменений в код
*   С помощью Estimators удобнее делиться своими моделями с другими разработчиками
*   Можно разрабатывать современные модели с читаемым высокоуровневым кодом. Проще говоря,
    гораздо легче создавать модели с Estimators, чем с низкоуровневым API TensorFlow
*   Сами Estimators построены на `tf.keras.layers`, которые упрощают настройку модели
    под себя
*   Estimators строят граф
*   Estimators обеспечивают простой распределенный цикл обучения, который контролирует
    как и когда:

    *   строить граф
    *   инициализировать переменные
    *   загружать данные
    *   обрабатывать исключения
    *   создавать контрольные точки и восстанавливаться при неудачных попытках
    *   сохранять статистику в TensorBoard

При написании приложения с Estimators ты должен отделять загрузку входных данных
от самой модели. Это разделение упрощает эксперименты с разными наборами данных.


## Готовые Estimators

Готовые Estimators позволяют тебе работать на более высоком уровне, по сравнению
с базовым API TensorFlow. Тебе больше не нужно волноваться о построении вычислительного
графа или сессиях обучения, поскольку Estimators сами делают за тебя всю работу.
Таким образом Estimators сами создают и управляют объектами `tf.Graph` и 
`tf.Session`. Более того, готовые Estimators позволяют тебе экспериментировать с 
разными архитектурами с минимальными изменениями исходного кода. Например,
`tf.estimator.DNNClassifier` - это готовый класс Estimator, который обучает
классификации модели на основе нейронной сети прямого распространения, которая 
состоит из *Dense* слоев.


### Структура программ с готовыми Estimators

Программа TensorFlow на основе готовых Estimators обычно состоит из следующих
четырех шагов:

1.  **Написание одной или более функций для загрузки датасета**. Например,
    создадим функцию для импорта тренировочного сета и вторую функцию для
    импорта проверочного сета данных. Каждая функция для загрузки датасета
    должна возвращать два объекта:

    *   словарь, в котором ключи являются именами параметров, а значения
        являются тензорами (или *SparseTensors*), содержащие соответствующие
        данные параметров
    *   тензор, содержащий одну или более меток

    Например, в коде ниже показан пример основного скелета для функции ввода
    данных:

```python
        def input_fn(dataset):
           ...  # манипулирует датасетом, извлекая словарь параметров и метки
           return feature_dict, label
```

Смотри подробнее в статье [Загрузка данных и датасетов](../guide/datasets.md)

2.  **Определение колонок параметров.** Каждая колонка `tf.feature_column`
    определяет имя параметра, его тип и любую предварительную обработку
    входных данных. Например, в следующем примере кода мы создадим три
    колонки параметров, в которых будут храниться данные в формате целых
    чисел или чисел с плавающей запятой. Первые две колонки параметров будут
    просто идентифицировать имя и тип параметра. Третья колонка параметров указывает
    на лямбду-выражение, которое будут вызываться для оценки необработанных
    данных:

```python
# Определим три числовых колонки параметров.
population = tf.feature_column.numeric_column('population')
crime_rate = tf.feature_column.numeric_column('crime_rate')
median_education = tf.feature_column.numeric_column('median_education',
                       normalizer_fn=lambda x: x - global_education_mean)
```

3.  **Укажем подходящий готовый Estimator.**  Например так мы укажем
    готовый Estimator для решения модели `линейного классификатора`:

```python
# Указываем estimator, передаем колонки параметров.
estimator = tf.estimator.LinearClassifier(
    feature_columns=[population, crime_rate, median_education],
)
```

4.  **Вызов метода обучения, оценки или предсказания**
    Например, все Estimators имеют метод `train` для начала обучения модели:

```python
# `input_fn` - функция, созданная в самом первом шаге
estimator.train(input_fn=my_training_set, steps=2000)
```

### Преимущества использования готовых Estimators

В готовых Estimators используются лучшие практики, которые обеспечивают
следующие преимущества:

*   Лучшие практики для определения какие части вычислительного графа
    запускать сначала, а также стратегии для обучения на одном устройстве
    или целом кластере
*   Стандартизированная практика ведения логов и получения полезной статистики

Если ты не собираешься использовать готовые Estimators, то тогда тебе
придется указывать все необходимые параметры самому.


## Собственные Estimators

Ядром каждого Estimator, готового или написанного с нуля, является
**функция модели**, которая представляет из себя метод для построения
графа для обучения, оценки и предсказаний. Когда ты используешь готовый
Estimator, кто-то уже написал функцию модели для тебя. В том случае,
когда ты полагаешься на свой собственный Estimator, ты должен сам
написать эту функцию. Более подробно о том, как написать функцию модели
ты можешь узнать в статье [Написание собственных Estimators](../guide/custom_estimators.md)


## Рекомендуемый ход работы

Мы рекомендуем следующий порядок создания модели с помощью Estimators:

1.  Предположим, что есть готовый Estimator, и мы используем его для
    построения нашей модели, а также используем результаты оценки для 
    формирования эталонной модели
2.  Создаем и тестируем процесс загрузки данных, проверяем целостность и
    надежность наших данных с готовым Estimator
3.  Если есть другие подходящие альтернативы, тогда экспериментируем с ними
    для поиска Estimator, который покажет лучшие результаты
4.  Возможно потребуется улучшить нашу модель при помощи создания нашего
    собственного Estimator.


## Создание Estimators из моделей Keras 

Ты можешь конвертировать уже имеющиеся у тебя модели Keras в Estimators. Это позволит
тебе использовать все преимущества Estimators для данной модели, например, для распределенного
обучения. Вызови функцию `tf.keras.estimator.model_to_estimator` как в примере ниже:

```python
# Создаем модель Inception v3 в Keras:
keras_inception_v3 = tf.keras.applications.inception_v3.InceptionV3(weights=None)

# Компилируем модель с оптимизатором, функцией потерь и метриками обучения по выбору.
keras_inception_v3.compile(optimizer=tf.keras.optimizers.SGD(lr=0.0001, momentum=0.9),
                          loss='categorical_crossentropy',
                          metric='accuracy')

# Создаем Estimator из скомпилированной модели Keras. Обрати внимание, что изначальное
# состояние модели Keras сохраняется при создании Estimator.
est_inception_v3 = tf.keras.estimator.model_to_estimator(keras_model=keras_inception_v3)

# Теперь мы можем использовать полученный Estimator как любой другой.
# Для начала восстановим вводное имя (или имена) модели Keras, чтобы мы могли использовать их
# как имена колонок параметров функции ввода данных Estimator:
keras_inception_v3.input_names  # выводит: ['input_1']

# Как только мы получим вводные имена, мы можем создать функцию ввода данных, например,
# для входа данных в формате NumPy ndarray:
train_input_fn = tf.estimator.inputs.numpy_input_fn(
    x={"input_1": train_data},
    y=train_labels,
    num_epochs=1,
    shuffle=False)

# Для обучения вызываем функцию `train` полученного нами Estimator:
est_inception_v3.train(input_fn=train_input_fn, steps=2000)
```

Обрати внимание, что имена колонок параметров и меток Esitmator мы получили
из соответствующей модели Keras. Например, имена вводных ключей для `train_input_fn`
выше могут быть получены из `keras_inception_v3.input_names`, и таким же образом
предсказанные имена могут быть получены из `keras_inception_v3.output_names`.

Подробнее смотри документацию в статье `tf.keras.estimator.model_to_estimator`.
